<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ club.name }} - Club Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
</head>
<body class="club-dashboard">
    <div class="header">
        <h1>{{ club.name }}</h1>
        <p class="subtitle">{{ club.description }}</p>
    </div>

    <div class="dashboard-container">
        <!-- Club Info Section -->
        <div class="card">
            <h2><span class="material-icons">info</span> Club Information</h2>
            <div class="profile-info">
                <div class="info-item">
                    <span class="info-label">Club Name:</span>
                    <span class="info-value">{{ club.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Description:</span>
                    <span class="info-value">{{ club.description }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ club.created_at|date:"F d, Y" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Members:</span>
                    <span class="info-value">{{ club.members.count }} member{{ club.members.count|pluralize }}</span>
                </div>
            </div>

            <h2 style="margin-top: 2rem;"><span class="material-icons">group</span> Members</h2>
            <div class="clubs-grid">
                {% for member in club.members.all %}
                    <div class="club-item">
                        <div class="club-name">{{ member.first_name }} {{ member.last_name|default:"" }}</div>
                        <div class="club-description">{{ member.email }}</div>
                        <div class="club-description">Joined: {{ member.date_joined|date:"M Y" }}</div>
                    </div>
                {% empty %}
                    <div class="feature-item">
                        <div class="feature-title"><span class="material-icons">person_add</span> No Members Yet</div>
                        <div class="feature-description">This club is waiting for its first members to join!</div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Chat Section -->
        <div class="card chat-section">
            <h2><span class="material-icons">chat</span> Club Chat</h2>
            
            {% if user.is_authenticated and is_member %}
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="chat-message-input" class="chat-input" placeholder="Type your message..." maxlength="500">
                    <button id="chat-message-submit" class="send-btn">Send</button>
                </div>
            {% else %}
                <div class="feature-item">
                    <div class="feature-title"><span class="material-icons">lock</span> Members Only</div>
                    <div class="feature-description">
                        {% if not user.is_authenticated %}
                            Please log in to access the club chat.
                        {% else %}
                            You need to be a member of this club to participate in the chat.
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    {% if user.is_authenticated and is_member %}
    <script>
        // Get club ID from Django template
        const clubId = {{ club.id|default:"null" }};
        
        if (clubId) {
            const chatSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/' + clubId + '/'
            );

            const chatMessages = document.querySelector('#chat-messages');
            const messageInput = document.querySelector('#chat-message-input');
            const messageSubmit = document.querySelector('#chat-message-submit');

            // Load existing messages
            fetch('/api/clubs/' + clubId + '/messages/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(message => {
                        displayMessage(message);
                    });
                    scrollToBottom();
                })
                .catch(error => console.error('Error loading messages:', error));

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                displayMessage(data);
                scrollToBottom();
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            function displayMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                const timestamp = new Date(message.timestamp).toLocaleString();
                
                messageElement.innerHTML = 
                    '<div class="message-author">' + message.author + '</div>' +
                    '<div class="message-content">' + message.content + '</div>' +
                    '<div class="message-time">' + timestamp + '</div>';
                
                chatMessages.appendChild(messageElement);
            }

            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function sendMessage() {
                const message = messageInput.value.trim();
                if (message) {
                    chatSocket.send(JSON.stringify({
                        'message': message
                    }));
                    messageInput.value = '';
                }
            }

            messageSubmit.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Focus on input when page loads
            messageInput.focus();
        }
    </script>
    {% endif %}
    
    <script src="{% static 'js/global-session-timer.js' %}"></script>
</body>
</html>
